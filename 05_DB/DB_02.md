## DB 02



## Model Relationship 

### A Many to Many relationship

> M:N (ë‹¤ëŒ€ë‹¤ ê´€ê³„) ë¥¼ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” í•„ë“œ
>
> RelatedManager ë¥¼ í†µí•´ ê´€ë ¨ ê°œì²´ë¥¼ ì¶”ê°€(add), ì œê±°(remove)



#### ì¤‘ê°œ ëª¨ë¸

class Doctor ê³¼ class Patient ë¥¼ ì¤‘ê°œí•˜ëŠ” class Reservation

ê°ê°ì˜ í´ë˜ìŠ¤ëŠ” ì¤‘ê°œ í…Œì´ë¸”ê³¼ 1: N ê´€ê³„

class Doctor 1 : class Reservation N : `doctor.reservation_set.all()`

class Patient 1 : class Reservation N :` patient.reservation_set.all()`



###  Argument

#### through

- ì¶”ê°€ ë°ì´í„°ë¥¼ ë‹¤ëŒ€ë‹¤ ê´€ê³„ì™€ ì—°ê²°í•˜ë ¤ëŠ” ê²½ìš° ì¤‘ê°œ í…Œì´ë¸” ì§ì ‘ ì§€ì •
- through ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì¤‘ê°œ í…Œì´ë¸”ì„ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤.



class Patient (Many to Many field ë¥¼ ê°€ì§„ ìª½ -> ì¤‘ê°œ í…Œì´ë¸”ì„ ë§Œë“ ë‹¤)

`'through=reservation'`



##### cf) ì¤‘ê°œ í…Œì´ë¸”ì„ ê±°ì¹˜ì§€ ì•Šê³  manager í†µí•´ ê°€ì ¸ì˜¤ê¸°

`patient.doctors.all() ` (ì—¬ê¸°ì„œ doctors ëŠ” í•„ë“œ ì´ë¦„)



##### í•„ë“œ ì´ë¦„ í˜•ì„± ê·œì¹™

![image-20210331104515530](DB_02.assets/image-20210331104515530.png)





#### Related_name

class Doctor

`related_name='patients'` (í•„ë“œê°€ ì—†ëŠ” ì¸¡ì—ì„œ í•„ë“œê°€ ìˆëŠ” ì¸¡ì„ ì—­ì°¸ì¡°)

`doctor.patients.all()` 



- ForeignKey ì˜ related_name ê³¼ ë™ì¼
  - ì¤‘ë³µë˜ë©´ M:N ìª½ì„ í•„ìˆ˜ ë³€ê²½í•œë‹¤.
- target model ì´ source model ì„ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©í•  manager name



##### source & target 

- source
  - ê´€ê³„ í•„ë“œë¥¼ ê°€ì§„ ëª¨ë¸
- target
  -  ê´€ê³„ í•„ë“œë¥¼ í†µí•´ ì°¸ì¡°ë˜ëŠ” ëª¨ë¸



#### symmetrical

```python
from django.db import models

class Person(models.Model):
    friends = models.ManyToManyField('self')
```



- ìê¸° ì°¸ì¡°
- `models.ManyToManuField('self')`
- ìœ„ì²˜ëŸ¼ ë™ì¼í•œ ëª¨ë¸ì„ ê°€ë¦¬í‚¤ëŠ” ì •ì˜ì˜ ê²½ìš° person_set ë§¤ë‹ˆì € ì¶”ê°€ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ëŒ€ì¹­ì ì´ë¼ê³  ê°„ì£¼í•˜ë©°  í•œ ìª½ì´ ì°¸ì¡°í•˜ë©´ ë ˆì½”ë“œê°€ ì¶”ê°€ë˜ëŠ” ê²ƒ
  - ë‚´ê°€ ë„ˆì˜ ì¹œêµ¬ë¼ë©´ ë„ˆëŠ” ë‚˜ì˜ ì¹œêµ¬
- self ì™€ì˜ M:N ëŒ€ì¹­ ê´€ê³„ì—ì„œ ëŒ€ì¹­ì„ ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° `symmetrical` ë¥¼ `False` ë¡œ ì„¤ì • (ê¸°ë³¸ì€ True)
  - ë³´í†µ ëŒ€ì¹­ì´ ì•„ë‹˜ (íŒ”ë¡œì‰ ìˆ˜ != íŒ”ë¡œìš° ìˆ˜)



### ğŸ¨Related manager

- 1:N ë˜ëŠ” M:N ê´€ë ¨ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë§¤ë‹ˆì €
  - doctors, patient_set
  - `related_name` ìœ¼ë¡œ manager ì´ë¦„ ë³€ê²½ ê°€ëŠ¥
  - manager ë¼ë¦¬ëŠ” ì´ë¦„ì´ ê²¹ì¹˜ë©´ ìƒì„±ì´ ì•ˆ ëœë‹¤.

#####  related manager method

- ê°™ì€ ì´ë¦„ì˜ ë©”ì„œë“œì—¬ë„ ê° ê´€ê²Œì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë™ì‘
- 1:N ì—ì„œëŠ” target ëª¨ë¸ ê°ì²´ë§Œ ì‚¬ìš© ê°€ëŠ¥ (`1:target`, `N:source`), (ì—­ì°¸ì¡°í•  ë•Œ)
- M:N ì—ì„œëŠ” ê´€ë ¨ëœ ë‘ ê°ì²´ì—ì„œ ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥
- `add`
  - ì§€ì •ëœ ê°ì²´ë¥¼ ê´€ë ¨ ê°ì²´ ì§‘í•©ì— ì¶”ê°€
  - ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê´€ê³„ì— ë‹¤ì‹œ ì‚¬ìš©í•˜ë©´ ë³µì œë˜ì§€ ì•ŠìŒ
- `remove`
  - ê´€ë ¨ ê°ì²´ ì§‘í•©ì—ì„œ ì§€ì •ëœ ëª¨ë¸ ê°ì²´ë¥¼ ì œê±°
- create
- clear
- set

https://docs.djangoproject.com/en/3.1/ref/models/relations/



### ì‹¤ìŠµ (ë³‘ì›: ì˜ì‚¬ì™€ í™˜ì)

- 1:N ì˜ í•œê³„
  - ë‹¤ë¥¸ ì˜ì‚¬ì—ê²Œ ë°©ë¬¸í•œ ê¸°ë¡ì„ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ì˜ˆì•½ì„ ìƒˆë¡œ ìƒì„±í•´ì•¼
  - ë°©ë¬¸ ì˜ˆì•½ì„ 1 ì—ì„œ 2 ì˜ì‚¬ë¡œ ë³€ê²½í•˜ê¸° ìœ„í•´ì„œë„ ì˜ˆì•½ì„ ìƒˆë¡œ ìƒì„±í•´ì•¼
- ì˜ˆì•½ ì •ë³´ ê¸°ë¡í•˜ëŠ” í…Œì´ë¸”ì´ í•„ìš”í•˜ë‹¤.
  - ì¤‘ê°œëª¨ë¸
  - doctor ì™€ 1: N, patient ì™€ 1:N
  - doctor FK, patient FK ë¥¼ ê°€ì§„ë‹¤.
- ì—­ì°¸ì¡° ê°€ëŠ¥
  - doctor1.reservations_set.all()
  - patient.reservations_set.all()



#### M:N ì§€ì› Field : Many to Many

- ë‘ ëª¨ë¸ ì¤‘ ì–´ëŠ ê³³ì— ë‘¬ë„ ê´œì°®ë‹¤. 
  - doctor, patient ë‘˜ ì¤‘ í•˜ë‚˜
- ì‘ëª…ì‹œ ë³µìˆ˜í˜•ìœ¼ë¡œ ì‘ì„±
  - doctors = `models.ManyToManyField(Doctor)`
- ì¤‘ê°œ ëª¨ë¸ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
  - appì´ë¦„ _ modelì´ë¦„ _ fieldì´ë¦„

![image-20210331094625468](DB_02.assets/image-20210331094625468.png)

- ì„œë¡œë¥¼ ì§ì ‘ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤
- ìƒˆë¡œìš´ DB API ë¥¼ ì‚¬ìš©í•œë‹¤.
  - `add`
  - ê´€ê³„ë¥¼ ì¶”ê°€í•œë‹¤
  - `remove`
  - ê´€ê³„ë¥¼ ëŠëŠ”ë‹¤.

```python
patient1.doctors.add(doctor1)
patient1.doctors.all()

# ë‚˜ë¥¼ ì°¸ì¡°í•˜ëŠ” í•„ë“œë¥¼ ê°€ì§„ ê°ì²´ë¥¼ ì°¸ì¡°í•œë‹¤ = ì—­ì°¸ì¡°
# í•„ë“œê°€ ì—†ëŠ” ì¸¡ì—ì„œ í•„ë“œê°€ ìˆëŠ” ì¸¡ì„ ì°¸ì¡°í•œë‹¤ëŠ” ê²ƒ
doctor1.patient_set.all()
doctor1.patient_set.add(patient2)

patient2.doctors.all()

# ê´€ê²Œ ëŠê¸°
doctor1.patient_set.remove(patient1)
patient2.doctors.remove(doctor1)
```



##### ì¤‘ê°œ í…Œì´ë¸”ì„ ì§ì ‘ ì‘ì„±í•´ì•¼ í•˜ëŠ” ê²½ìš°?

- ê¸°ë³¸ ì™¸ë˜í‚¤ ì œì™¸ í•˜ê³   ì¶”ê°€ì ìœ¼ë¡œ íŒŒìƒ í•„ë“œë¥¼ í•„ìš”ë¡œ í•  ê²½ìš°
- ì¤‘ê°œí…Œì´ë¸”ì´ ìˆì„ ê²½ìš° ëª…ë ¹ì–´ê°€ ì¶”ê°€ ëœë‹¤.

```python
class Patient(models.Model):
    name = models.TextField()
    doctors = models.ManyToManyField(Doctor, through='Reservation')
```



##### ì—­ì°¸ì¡° ëª¨ë¸ ë§¤ë‹ˆì € ì´ë¦„ ë°”ê¾¸ê¸°

- ì´ë¦„ ê·œì¹™ í†µì¼í•˜ë ¤ê³ 
  - patient_set => patients
- `related_name`
  - related_name ì„ ì„¤ì •í•˜ë©´ ê¸°ì¡´ì˜ patient_set ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤

```python
class Patient(models.Model):
    name = models.TextField()
    doctors = models.ManyToManyField(Doctor, related_name='patients')
```





### like í•˜ê¸°

> user - article

#### ì¢‹ì•„ìš” ì—¬ë¶€ ê²€ì¦ ë©”ì„œë“œ : exist()

- ë™ì¼í•œ ì¿¼ë¦¬ì§€ë§Œ in ë³´ë‹¤ ë¹ ë¥´ë‹¤
  - if í‰ê°€ì˜ ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥í•´ë‘ëŠ”ë°
  - ë™ì¼í•œ ì¿¼ë¦¬ì— ëŒ€í•´ì„œ ê°™ì€ ì¿¼ë¦¬ì…‹ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•¨
  - ê·¸ëŸ°ë° ì¿¼ë¦¬ì…‹ ìì²´ê°€ ì—„ì²­ í¬ë‹¤ë©´ ìºì‹œë¥¼ ë§ì´ ì°¨ì§€í•˜ê³ 
  - ìºì‹œ ì „ì²´ë¥¼ ì¡°íšŒí•˜ë©´ ì˜¤ë˜ ê±¸ë¦¼
  - ê·¸ëŸ¬ë‚˜ exists ëŠ” ì¿¼ë¦¬ì…‹ì„ ì €ì¥í•˜ì§€ ì•Šê³  ê·¸ ë•Œì—ë§Œ íŒë‹¨í•œë‹¤.
  - ë”°ë¼ì„œ ì¿¼ë¦¬ì…‹ì˜ í¬ê¸°ê°€ í¬ê³  ì „ì²´ ì¡°íšŒê°€ í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´ exists ë¥¼ ì“°ëŠ” ê²ƒì´ ì¢‹ë‹¤.

![image-20210331140706787](DB_02.assets/image-20210331140706787.png)



##### Queryset are LAZY

- ì¿¼ë¦¬ì…‹ì„ ë§Œë“œëŠ” ì‘ì—…ì—ëŠ” DB ì‘ì—…ì´ í¬í•¨ë˜ì§€ ì•ŠëŠ”ë‹¤ (DBê°€ ê´€ì—¬í•˜ì§€ ì•ŠëŠ”ë‹¤)
  - í•„í„° ì²´ì´ë‹ì„ í•´ë„ ê·¸ ìì²´ëŠ” DB ì‘ì—…ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê´œì°®ë‹¤.
- ê·¸ëŸ¼ ì–¸ì œ DB ì— ë³´ë‚´ëŠ”ê°€?
  - í‰ê°€ (hit, assess, query)
  - ì¿¼ë¦¬ë¥¼ DB ë¡œ ë‚ ë¦°ë‹¤ (ë¬´ê±°ìš´ ì‘ì—…ì´ê¸° ë•Œë¬¸)
  - ì¿¼ë¦¬ì…‹ì„ cache ë¡œ ë§Œë“ ë‹¤.
- í‰ê°€ëŠ” ì–¸ì œ ì´ë£¨ì–´ì§€ëŠ”ê°€?
  - ë°˜ë³µë¬¸, ì¡°ê±´ë¬¸,  ì¶œë ¥
    - Iteration ì¿¼ë¦¬ì…‹ì€ ë°˜ë³µ ê°€ëŠ¥í•˜ë©° ì²˜ìŒ ë°˜ë³µí•  ë•Œ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰(í‰ê°€)
    - bool()
  - https://docs.djangoproject.com/en/3.1/ref/models/querysets/#when-querysets-are-evaluated
- í‰ê°€ì˜ ê²°ê³¼ëŠ” 
  - ì¿¼ë¦¬ì…‹ì˜ ë‚´ì¥ cache ì— ì €ì¥ëœë‹¤
  - ë‹¤ì‹œ ìˆœíšŒí•  ë•Œ ë˜ í‰ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.
- cache ë¥¼ ì´ìš©í•´ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥
  - í‰ê°€ë¥¼ ê±°ì¹˜ë©´ cache ì— ì €ì¥ëœë‹¤ëŠ” ì ì„ ì´ìš©
  - íŠ¹ì • ê°ì²´ë¥¼ slicing, index ë¡œ ì ‘ê·¼ í•  ë•Œì—” cache ì €ì¥í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤

![image-20210331154425062](DB_02.assets/image-20210331154425062.png)



##### cache í™œìš©í•˜ê¸°

- DB ì— ì¿¼ë¦¬ë¥¼ ìµœì†Œí•œìœ¼ë¡œ ë³´ë‚´ê¸° ìœ„í•œ ìµœì í™” ë°©ë²•

```python

like_set = article.like_users.filter(pk=request.user.pk)
if like_set:  # í‰ê°€
    # ì¿¼ë¦¬ì…‹ì˜ ì „ì²´ ê²°ê³¼ê°€ í•„ìš”í•˜ì§€ ì•Šì€ ìƒí™©ì„ì—ë„
    # ORM ì€ ì „ì²´ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ cache ì— ë‹´ëŠ”ë‹¤
    article.like_users.remove(request.user)

# ê°œì„  1
# exists() ì¿¼ë¦¬ì…‹ ìºì‹œë¥¼ ë§Œë“¤ì§€ ì•Šìœ¼ë©´ì„œ íŠ¹ì • ë ˆì½”ë“œê°€ ìˆëŠ”ì§€ ê²€ì‚¬
if like_set.exists():
    # DB ì—ì„œ ê°€ì ¸ì˜¨ ë ˆì½”ë“œê°€ ì—†ë‹¤ë©´ ë©”ëª¨ë¦¬ë¥¼ ì ˆì•½í•  ìˆ˜ ìˆë‹¤.
    article.like_users.remove(request.user)
    
# ë§Œì•½ If ë¬¸ ì•ˆì—ì„œ ë°˜ë³µë¬¸ì´ ìˆë‹¤ë©´?
# if ì—ì„œ í‰ê°€ í›„ ìºì‹±
if like_set:
    for user in like_set:  # ìˆœíšŒ í•  ë•Œì—ëŠ” ìœ„ì—ì„œ ì´ë¯¸ í‰ê°€ê°€ ì´ë£¨ì–´ì¡Œìœ¼ë¯€ë¡œ cache ì‚¬ìš©
        print(user.username)
        
# ë§Œì•½ ì¿¼ë¦¬ì…‹ ìì²´ê°€ ë„ˆë¬´ í¬ë‹¤ë©´?
# iterator()
# ë°ì´í„°ë¥¼ ì‘ì€ ë©ì–´ë¦¬ë¡œ ìª¼ê°œì–´ ê°€ì ¸ì˜¤ê³ , ì´ë¯¸ ì‚¬ìš©í•œ ë ˆì½”ë“œëŠ” ë©”ëª¨ë¦¬ì—ì„œ ì§€ìš´ë‹¤
# ì „ì²´ ë ˆì½”ë“œì˜ ì¼ë¶€ë¥¼ DBì—ì„œ ê°€ì ¸ì˜¤ë¯€ë¡œ ë©”ëª¨ë¦¬ë¥¼ ì ˆì•½í•œë‹¤.
if like_set:
    for user in like_set.iterator(): 

# ì¿¼ë¦¬ì…‹ì´ ë„ˆë¬´ë„ˆë¬´ í¬ë‹¤ë©´? if í‰ê°€ ì¡°ì°¨ ë²„ê±°ìš¸ ìˆ˜ ìˆë‹¤.
if list_set.exists():
    for user in like_set.iterator():
```



###### ì•ˆì¼í•œ ìµœì í™”

ë„ë„ë“œ ì»¤ëˆ„ìŠ¤,  ì„£ë¶€ë¥¸ ìµœì í™”ëŠ” ëª¨ë“  ì•…ì˜ ê·¼ì›ì´ë‹¤.



### follow í•˜ê¸°

> user - user
>
> ì¬ê·€ì  ì°¸ì¡° (ëŒ€ëŒ“ê¸€)

#### models.py

```python
class User(AbstractUser):
    followings = models.ManyToManyField('self', symmetrical=False, related_name='followers')

```



- symmetrical ì„ False í•˜ë©´ ê·¸ë•Œ ë¶€í„°ëŠ” related manager ê°€ ì¡´ì¬í•˜ë¯€ë¡œ (ì—­ì°¸ì¡°ê°€ ê°€ëŠ¥)
- related_name ì„ ì„¤ì •í•´ì•¼ í•œë‹¤.
- ì¤‘ê°œ í…Œì´ë¸”ì´ ìƒì„±ëœë‹¤.
- ![image-20210331144312781](DB_02.assets/image-20210331144312781.png)



##### template ì—ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” êµ¬ë¬¸ ë³€ìˆ˜ë¡œ ì§€ì •í•˜ê¸°

- {% with %}{% endwith %}
  - with tag ì•ˆì—ì„œ ìœ íš¨í•œ ë³€ìˆ˜
  - ë¸”ëŸ­ì´ í¬ë‹¤ê³  ëŠê»´ì§€ë©´ include í•´ì„œ ì‚¬ìš©í•´ë„ ë  ê²ƒ

- ìµœì í™”ì™€ëŠ” ê´€ê³„ ì—†ë‹¤.

```django
 {% with  followings=person.followings.all followers=person.followers.all %}

  <div>
    íŒ”ë¡œì‰ : {{ followings|length }} / íŒ”ë¡œì›Œ : {{ followers|length }}
  </div>
      {% if request.user != person %}
        <div>
          <form action="{% url 'accounts:follow' person.pk %}" method="POST">
            {% csrf_token %}
            {% if request.user in followers %}
              <button>ì–¸íŒ”ë¡œìš°</button>
            {% else %}
              <button>íŒ”ë¡œìš°</button>
            {% endif %}
          </form>
        </div>
      {% endif %}
  {% endwith %}
```



##### ì„œë²„ì‚¬ì´ë“œì—ì„œ ì¤‘ìš”í•œ ê²ƒ

1. ëª¨ë¸ë§
2. ì¿¼ë¦¬ë¬¸